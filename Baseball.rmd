---
title: "Baseball Analysis"
author: "Brady Biehn"
date: "2025-08-29"
output: pdf_document
---

```{r}
# Load libraries
library(tidyverse)
library(mosaic)
library(ggfortify)
library(zoo)
library(forecast)
library(caret)
library(broom)
library(purrr)

# Load data
baseball <- read_csv("Baseball.csv") %>%
  mutate(teamID = factor(teamID))

# 1. 3-year Rolling Average & Weight Groups
baseball <- baseball %>%
  group_by(teamID) %>%
  arrange(yearID) %>%
  mutate(rolling_avg_wins = rollmean(wins, k = 3, fill = NA, align = "right")) %>%
  ungroup()

median_weight <- median(baseball$avg_weight, na.rm = TRUE)
baseball <- baseball %>%
  mutate(weight_group = ifelse(avg_weight >= median_weight, "Heavy", "Light"))

# 2. Cluster Analysis
cluster_data <- baseball %>%
  group_by(teamID, yearID) %>%
  summarize(avg_weight = mean(avg_weight, na.rm = TRUE),
            avg_height = mean(avg_height, na.rm = TRUE),
            roster_size = mean(roster_size, na.rm = TRUE),
            avg_games_played = mean(avg_games_played, na.rm = TRUE),
            wins = mean(wins, na.rm = TRUE),
            .groups = "drop")

cluster_scaled <- scale(cluster_data %>% select(avg_weight, avg_height, roster_size, avg_games_played))
kmeans_result <- kmeans(cluster_scaled, centers = 4, nstart = 25)
cluster_data$cluster <- kmeans_result$cluster

baseball <- baseball %>%
  left_join(cluster_data %>% select(teamID, yearID, cluster), by = c("teamID", "yearID"))

# 3. Regression Models & Predictions
baseball_lm <- lm(wins ~ avg_weight + avg_height + roster_size, data = baseball)
win_model <- lm(wins ~ avg_weight + avg_height + roster_size + avg_games_played, data = baseball)

baseball <- baseball %>%
  mutate(pred_wins_lm = predict(baseball_lm, newdata = baseball),
         pred_wins_full = predict(win_model, newdata = baseball))

team_models <- baseball %>%
  group_by(teamID) %>%
  nest() %>%
  mutate(
    model = map(data, ~ lm(wins ~ avg_weight + avg_height + roster_size, data = .x)),
    preds = map2(model, data, ~ augment(.x, newdata = .y))
  ) %>%
  unnest(preds)

baseball <- baseball %>%
  left_join(
    team_models %>% select(teamID, yearID, .fitted) %>% rename(pred_wins_team = .fitted),
    by = c("teamID", "yearID")
  )

regression_results <- bind_rows(
  tidy(baseball_lm) %>% mutate(model = "baseball_lm"),
  tidy(win_model) %>% mutate(model = "win_model")
)

regression_overview <- bind_rows(
  glance(baseball_lm) %>% mutate(model = "baseball_lm"),
  glance(win_model) %>% mutate(model = "win_model")
)

write_csv(regression_results, "Regression_Coefficients.csv")
write_csv(regression_overview, "Regression_Summaries.csv")

# 4. Monte Carlo Simulation
set.seed(123)
sims <- replicate(10000, {
  new_team <- data.frame(
    avg_weight = rnorm(1, mean(baseball$avg_weight), sd(baseball$avg_weight)),
    avg_height = rnorm(1, mean(baseball$avg_height), sd(baseball$avg_height)),
    roster_size = rnorm(1, mean(baseball$roster_size), sd(baseball$roster_size)),
    avg_games_played = rnorm(1, mean(baseball$avg_games_played), sd(baseball$avg_games_played))
  )
  predict(win_model, new_team)
})

sim_mean <- mean(sims)
sim_ci <- quantile(sims, probs = c(0.025, 0.975))

# Save all simulation draws
sims_df <- tibble(wins = sims)
write_csv(sims_df, "Simulation_Wins.csv")

# Save summary stats for Power BI
sim_summary <- tibble(
  sim_mean_wins = sim_mean,
  sim_lower_95 = sim_ci[1],
  sim_upper_95 = sim_ci[2]
)
write_csv(sim_summary, "Simulation_Summary.csv")


ggplot(sims_df, aes(x = wins)) +
  geom_histogram(aes(y = ..density..), bins = 40, fill = "skyblue", color = "black", alpha = 0.6) +
  geom_density(color = "red", size = 1) +
  geom_vline(xintercept = sim_mean, linetype = "dashed", color = "blue", size = 1) +
  geom_vline(xintercept = sim_ci, linetype = "dotted", color = "darkgreen", size = 1) +
  labs(title = "Monte Carlo Simulation of Expected Wins",
       subtitle = "Dashed = Mean | Dotted = 95% CI",
       x = "Simulated Wins", y = "Density") +
  theme_bw()

# 5. t-Test & ANOVA
ttest_res <- t.test(wins ~ weight_group, data = baseball)
anova_model <- aov(wins ~ weight_group * roster_size, data = baseball)
anova_res <- broom::tidy(anova_model)

ttest_table <- tibble(
  test = "t-test (wins)",
  statistic = ttest_res$statistic,
  p_value = ttest_res$p.value,
  df = ttest_res$parameter
)
write_csv(ttest_table, "t-TestResults.csv")

anova_table <- anova_res %>%
  mutate(test = "ANOVA")

write_csv(anova_table, "ANOVATestResults.csv")

# 6. Cluster Summary Tables
cluster_count <- cluster_data %>%
  group_by(yearID, cluster) %>%
  summarize(num_teams = n())

cluster_summary <- cluster_data %>%
  group_by(cluster) %>%
  summarize(
    avg_weight = mean(avg_weight),
    avg_height = mean(avg_height),
    avg_roster_size = mean(roster_size),
    avg_games_played = mean(avg_games_played),
    avg_wins = mean(wins)
  )

# 7. Weight Group Summary
weight_group_summary <- baseball %>%
  group_by(weight_group) %>%
  summarize(
    mean_wins = mean(wins, na.rm = TRUE),
    sd_wins = sd(wins, na.rm = TRUE),
    median_wins = median(wins, na.rm = TRUE),
    n = n()
  )

ggplot(baseball, aes(x = weight_group, y = wins, fill = weight_group)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Wins by Weight Group")

# 8. Rolling Average Plots
ggplot(baseball, aes(x = yearID, y = rolling_avg_wins, color = teamID)) +
  geom_line() +
  theme_minimal() +
  labs(title = "3-Year Rolling Average Wins by Team")

# 9. Save Full Baseball Dataset for Power BI (fixed export)
baseball_export <- baseball %>%
  mutate(
    weight_group = as.character(weight_group),
    cluster = as.integer(cluster)
  ) %>%
  distinct()

write_csv(baseball_export, "Baseball_with_outputs.csv")
```








